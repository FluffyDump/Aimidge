@page
@model IndexModel
@{
	ViewData["Title"] = "Home page";
}

<div class="text-center">
	<h1 class="display-4">Welcome to AIMIDGE!</h1>
	<label for="prompt">Enter your prompt!</label><br />
	<input type="text" id="prompt" name="prompt" /><br />

	<label for="resolution">Select resolution:</label><br />
	<select id="resolution" name="resolution">
		<option value="100x100">100x100</option>
		<option value="150x150">150x150</option>
		<option value="320x240">320x240</option>
		<option value="400x300">400x300</option>
		<option value="512x512">512x512</option>
	</select><br />
	<button id="submitButton" type="button">Submit</button>

	<div id="promptImage"></div>

	<div id="loadingSpinner" style="display: none;">
        <img src="/loading.gif" alt="Loading..." />
    </div>

	<script>
		document.getElementById('submitButton').addEventListener('click', async function () {
			document.getElementById('promptImage').innerHTML = '';
			const promptText = document.getElementById('prompt').value;
			const resolution = document.getElementById('resolution').value;
	
			document.getElementById('loadingSpinner').style.display = 'block';

			const existingCookie = await fetch('api/web/GetCookie', {
				method: 'POST'
			}).then(async resp => {
				const respText = await resp.text();
				if(respText === '404'){
					await fetch('api/web/SetCookie', {
						method: 'POST'
					}).then(async setResp => {
						if(setResp.ok){
							processPrompt();
						}
					})
				} else if(respText === 'ok'){
					processPrompt();
				} else {
					alert("Unable to check cookies!");
				}
			});


			async function processPrompt(){
				const response = await fetch('api/web/GetPrompt', {
				method: 'POST',
				headers: {
					'Content-Type': 'application/json'
				},
				body: JSON.stringify({ prompt: promptText, resolution: resolution })
			});

			if (response.ok) {
            	const data = await response.json();
            	const img = document.createElement('img');
            	img.src = 'data:image/jpg;base64,' + data.image;
            	document.getElementById('promptImage').appendChild(img);
            	document.getElementById('loadingSpinner').style.display = 'none';
        	} else {
            	console.error(response.statusText);
            	document.getElementById('loadingSpinner').style.display = 'none';
        		}
			}
		});
	</script>
</div>
